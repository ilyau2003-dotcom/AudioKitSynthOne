name: Build AudioKitSynthOne for iOS

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    runs-on: macos-13  # macOS 13 with Xcode 14.x compatibility
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Select Xcode 14.3.1
      run: sudo xcode-select -s /Applications/Xcode_14.3.1.app/Contents/Developer
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Install CocoaPods
      run: |
        sudo gem install cocoapods -v 1.12.1
        
    - name: Install dependencies
      run: |
        cd $GITHUB_WORKSPACE
        pod install
        
    - name: Build for iOS device
      run: |
        xcodebuild \
          -workspace AudioKitSynthOne.xcworkspace \
          -scheme AudioKitSynthOne \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath $GITHUB_WORKSPACE/build/AudioKitSynthOne.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Export unsigned IPA
      run: |
        mkdir -p $GITHUB_WORKSPACE/build/Payload
        cp -r $GITHUB_WORKSPACE/build/AudioKitSynthOne.xcarchive/Products/Applications/AudioKitSynthOne.app \
          $GITHUB_WORKSPACE/build/Payload/
        cd $GITHUB_WORKSPACE/build
        zip -r AudioKitSynthOne-unsigned.ipa Payload
        
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: AudioKitSynthOne-unsigned
        path: build/AudioKitSynthOne-unsigned.ipa
        retention-days: 7
